@using MindKey.Shared.Models.MindKey
@inject IUserService UserService
@inject IIdeaService IdeaService
@inject EventService EventService

<div class="progress" style="height: 10px;"><div class="progress-bar" role="progressbar" style="width: @Width%" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div></div>
<br />
@if (Idea == null || IdeaUserComment == null)
{
    <button class="btn btn-primary" disabled>
        <i class="oi oi-thumb-up" title="Agree" aria-hidden="true"></i>
    </button>
    <span class="badge border-secondary border-1 text-secondary">0</span>

    <button class="btn btn-primary" disabled>
        <i class="oi oi-thumb-down" title="Disagree" aria-hidden="true"></i>
    </button>
    <span class="badge border-secondary border-1 text-secondary">0</span>

    <button class="btn btn-primary" disabled>
        <i class="oi oi-loop-square" title="Nutral" aria-hidden="true"></i>
    </button>

    <span class="badge border-secondary border-1 text-secondary">0</span>

}
else
{

    @if ((IdeaUserComment.User != null && IdeaUserComment.Argument != ArgumentType.For) || disable)
    {
        <button class="btn btn-primary" disabled>
            <i class="oi oi-thumb-up" title="Agree" aria-hidden="true"></i>
        </button>
    }
    else if (IdeaUserComment.User != null && IdeaUserComment.Argument == ArgumentType.For)
    {
        <button class="btn btn-info" disabled>
            <i class="oi oi-thumb-up" title="Agree" aria-hidden="true"></i>
        </button>
    }
    else
    {
        <button class="btn btn-primary" @onclick="()=>Agree()">
            <i class="oi oi-thumb-up" title="Agree" aria-hidden="true"></i>
        </button>
    }
    <span class="badge border-secondary border-1 text-secondary">@ToKiloFormat(Idea.ForCount)</span>
    @if ((IdeaUserComment.User != null && IdeaUserComment.Argument != ArgumentType.Against) || disable)
    {
        <button class="btn btn-primary" disabled>
            <i class="oi oi-thumb-down" title="Disagree" aria-hidden="true"></i>
        </button>
    }
    else if (IdeaUserComment.User != null && IdeaUserComment.Argument == ArgumentType.Against)
    {
        <button class="btn btn-info" disabled>
            <i class="oi oi-thumb-down" title="Disagree" aria-hidden="true"></i>
        </button>
    }
    else
    {
        <button class="btn btn-primary" @onclick="()=>Disagree()">
            <i class="oi oi-thumb-down" title="Disagree" aria-hidden="true"></i>
        </button>
    }
    <span class="badge border-secondary border-1 text-secondary">@ToKiloFormat(Idea.AgainstCount)</span>
    @if ((IdeaUserComment.User != null && IdeaUserComment.Argument != ArgumentType.Nutral) || disable)
    {
        <button class="btn btn-primary" disabled>
            <i class="oi oi-loop-square" title="Nutral" aria-hidden="true"></i>
        </button>
    }
    else if (IdeaUserComment.User != null && IdeaUserComment.Argument == ArgumentType.Nutral)
    {
        <button class="btn btn-info" disabled>
            <i class="oi oi-loop-square" title="Nutral" aria-hidden="true"></i>
        </button>
    }
    else
    {
        <button class="btn btn-primary" @onclick="()=>Nutral()">
            <i class="oi oi-loop-square" title="Nutral" aria-hidden="true"></i>
        </button>
    }

    <span class="badge border-secondary border-1 text-secondary">@ToKiloFormat(Idea.NetrulCount)</span>
}

@code {
    [Parameter]
    public Idea Idea { get; set; } = null;
    public IdeaUserComment? IdeaUserComment { get; set; } = null;
    public decimal Width { get; set; } = 0;
    public bool disable { get; set; } = true;
    protected override void OnInitialized()
    {
        base.OnInitialized();
    }
    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
    }
    public async Task Agree()
    {
        await UpdateVote(ArgumentType.For);
        StateHasChanged();
    }

    public async Task Disagree()
    {
        await UpdateVote(ArgumentType.Against);
        StateHasChanged();
    }


    public async Task Nutral()
    {
        await UpdateVote(ArgumentType.Nutral);
        StateHasChanged();
    }
    private async Task UpdateVote(ArgumentType type)
    {
        var idea = await IdeaService.GetIdea(Idea.Id);
        var ideaUserComment = new IdeaUserComment
            {
                Argument = type,
                Idea = idea,
                User = UserService.User ?? new User(),
                Title = "Test Title",
                Description = "Test Description",
            };
        ideaUserComment.User.Password = "***";

        if (await IdeaService.SetAurgument(ideaUserComment))
        {
            IdeaUserComment = await IdeaService.GetSetAgument(ideaUserComment);
        }
        Idea = await IdeaService.GetIdea(Idea.Id);
        if (Idea.AgainstCount == 0)
        {
            Idea.AgainstCount = 1;
        }
        Width = (Convert.ToDecimal(Idea.ForCount) / Convert.ToDecimal(Idea.AgainstCount + Idea.ForCount)) * 100;
    }

    public string ToKiloFormat(long num)
    {
        return num switch
        {
            >= 100000000 => (num / 1000000D).ToString("0.#M"),
            >= 1000000 => (num / 1000000D).ToString("0.##M"),
            >= 100000 => (num / 1000D).ToString("0.#k"),
            >= 10000 => (num / 1000D).ToString("0.##k"),
            _ => num.ToString("#,0")
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Idea?.Person == null)
        {
            return;
        }
        EventService.ChangeLoadingStatus(true, "AgreeDisagreeComponent-OnParametersSetAsync()");
        if (Idea.AgainstCount == 0)
        {
            Idea.AgainstCount = 1;
        }
        Width = (Convert.ToDecimal(Idea.ForCount) / Convert.ToDecimal(Idea.AgainstCount + Idea.ForCount)) * 100;
        if (UserService.User != null && Idea?.Person != null)
            disable = (Idea.Person.PersonId == UserService.User.Id);
        //Idea = await IdeaService.GetIdea(Idea.Id);
        var ideaUserComment = new IdeaUserComment
            {
                Argument = ArgumentType.Nutral,
                Idea = Idea,
                User = UserService.User ?? new User(),
                Title = "Test Title",
                Description = "Test Description",
            };
        ideaUserComment.User.Password = "***";
        IdeaUserComment = await IdeaService.GetSetAgument(ideaUserComment);
        EventService.ChangeLoadingStatus(false, "AgreeDisagreeComponent-OnParametersSetAsync()");
        await base.OnParametersSetAsync();
    }
}
