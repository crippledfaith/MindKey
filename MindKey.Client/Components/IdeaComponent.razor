@using MindKey.Shared.Models.MindKey

@inject NavigationManager navManager
@inject EventService EventService
@inject IIdeaService IdeaService
@inject IJSRuntime JSRuntime
@if (Idea==null || Idea.Id == 0)
{
        <div class="card info-card">
        <div class="card-body">
            <h5 class="card-title">Loading..</h5>
            <div id="toolbar" style="visibility:collapse"> </div>
            <QuillComponent @ref="Quill" Disable="true" HideToolBar="true" DefaultText="Loading..." />
            <span class="badge border-secondary border-1 text-primary" style="cursor:pointer" @onclick="()=>OpenCard()">@ShowMoreText</span>
            <br />
            <IdeaUserPanelComponent Idea="@null" />
            <AgreeDisagreeComponent Idea="@null" />
            <CommentComponent Idea="@null" />
        </div>
    </div>
}
else
{
    <div class="card info-card">
        <div class="card-body">
            <h5 class="card-title">@Idea.Title</h5>
            <div id="toolbar" style="visibility:collapse"> </div>
            <QuillComponent @ref="Quill" Disable="true" HideToolBar="true" DefaultText="@Idea.DescriptionShort" />
            <span class="badge border-secondary border-1 text-primary" style="cursor:pointer" @onclick="()=>OpenCard()">@ShowMoreText</span>
            <br />
            <IdeaUserPanelComponent Idea="@Idea" />
            <AgreeDisagreeComponent Idea="@Idea" />
            <CommentComponent Idea="@Idea" />
        </div>
    </div>
}

@code {
    [Parameter]
    public Idea Idea { get; set; } = null;
    public bool IsShowAll { get; set; } = false;
    public string Description { get; set; }
    private ElementReference divEditorElement;
    public QuillComponent Quill { get; set; }
    public string ShowMoreText { get; set; } = "Show More...";
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            IsShowAll = true;
        }
        base.OnAfterRender(firstRender);
    }

    protected override void OnInitialized()
    {
        EventService.EditIdeaEvent += EditIdea;
        EventService.DeleteIdeaEvent += DeleteIdea;
        EventService.HideAllStoriesEvent += HideAllStories;
        base.OnInitialized();
    }
    protected override async Task OnParametersSetAsync()
    {
        //ShowHideText(false);
        //await base.OnParametersSetAsync();
    }
    
    public void EditIdea(Idea idea)
    {
        navManager.NavigateTo($"/makepost/{idea.Id}");
    }
    public void DeleteIdea(Idea idea)
    {

    }
    public void HideAllStories(Idea idea)
    {
        if (idea.Id != Idea.Id)
        {
            IsShowAll = false;
            OpenCard();
        }
    }
    public async void OpenCard(bool render = true)
    {
        if (IsShowAll)
        {
            ShowMoreText = "Hide...";
            EventService.HideAllStories(Idea);
            await Quill.SetContent(Idea.Description);
        }
        else
        {
            ShowMoreText = "Show More...";
            await Quill.SetContent(Idea.DescriptionShort);
        }
        IsShowAll = !IsShowAll;
        if (render)
            StateHasChanged();

    }

}
