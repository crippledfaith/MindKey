@page "/wall"
@page "/wall/{Page}"
@using MindKey.Client.Components
@using MindKey.Shared.Models.MindKey
@using System.Text
@inject IIdeaService IdeaService
@inject Microsoft.AspNetCore.Components.NavigationManager UriHelper
@inject PageHistoryState PageHistoryState
@inject IUserService UserService
@inject EventService EventService


<Pager Result=@Ideas PageChanged=PagerPageChanged />
@foreach (var idea in Ideas.Results)
{
    <IdeaComponent Idea="@idea" />
}
<Pager Result=@Ideas PageChanged=PagerPageChanged />

@code {
    [Parameter]
    public string Page { get; set; } = "1";
    [Parameter]
    public string Permission { get; set; } = "1";
    public PagedResult<Idea> EmptyIdeas { get; set; }
    public PagedResult<Idea> Ideas { get; set; }
    protected override void OnInitialized()
    {
        //EventService.ChangeLoadingStatus(true, "List-OnInitialized()");

        EmptyIdeas = new PagedResult<Idea>()
            {
                CurrentPage = 0,
                PageCount = 0,
                PageSize = 10,
                Results = new List<Idea> { new Idea(), new Idea(), new Idea(), new Idea(), new Idea(), new Idea(), new Idea(), new Idea(), new Idea() }
            };
        Ideas = EmptyIdeas;
        EventService.DeletedIdeaEvent -= DeletedIdea;
        EventService.DeletedIdeaEvent += DeletedIdea;
        EventService.LoginAndOutEvent += LoginAndOut;
        base.OnInitialized();
    }

    public async void DeletedIdea(Idea idea)
    {
        var results = (await IdeaService.GetIdeasOfOthers(Page, UserService.User?.Id));
        Ideas = results;
        StateHasChanged();
    }

    public async void LoginAndOut(bool isLoggedin)
    {
        if (isLoggedin)
        {
            var results = (await IdeaService.GetIdeasOfOthers(Page, UserService.User?.Id));
            Ideas = results;
            StateHasChanged();
        }
    }
    protected override async Task OnParametersSetAsync()
    {
        try
        {
            EventService.ChangeLoadingStatus(true, "List-OnParametersSetAsync()");
            //StateHasChanged();
            if (Page == null)
                Page = "1";
            var results = (await IdeaService.GetIdeasOfOthers(Page, UserService.User?.Id));
            Ideas = results;
            PageHistoryState.AddPageToHistory(UriHelper.Uri);
            EventService.ChangeLoadingStatus(false, "List-OnParametersSetAsync()");
        }
        catch (Exception)
        {
            EventService.ChangeLoadingStatus(false, "List-OnParametersSetAsync()");
            EventService.ShowMessage("No Internet Connection", MessageType.Error);
        }
        await base.OnParametersSetAsync();

    }

    protected void PagerPageChanged(int page)
    {
        EventService.ResetLoader();
        Ideas.Results = EmptyIdeas.Results;
        Ideas.CurrentPage = page;
        StateHasChanged();
        UriHelper.NavigateTo("/wall/" + page);
        PageHistoryState.AddPageToHistory(UriHelper.Uri);
    }
}